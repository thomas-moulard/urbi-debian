#! /bin/bash

# Copyright (C) 2008-2010, Gostai S.A.S.
#
# This software is provided "as is" without warranty of any kind,
# either expressed or implied, including but not limited to the
# implied warranties of fitness for a particular purpose.
#
# See the LICENSE file for more information.

PROG=lib.exe

me=$(basename "$0")

stderr ()
{
  local i
  for i
  do
    echo >&2 "$me (wrapper): $i"
  done
}

error ()
{
  local exit=$1
  shift
  stderr "$@"
  exit $exit
}

verbose ()
{
  case "$verbose: $VERBOSE " in
    (true:* | *" cl.exe "* | *" link.exe "* | " x ")
      stderr "$@"
      ;;
  esac
}

fatal ()
{
  error 1 "$@"
}

# Look for, and load, `msvc_env.sh'.
load_msvc_env ()
{
  local i
  # Skip if we can't run it.
  for i in ~/share/wine ~/.wine/drive_c $(dirname $0) ~/bin
  do
    local f=$i/msvc_env.sh
    verbose "trying to load $f"
    if test -f $f; then
      . $f
      verbose "loaded $f"
      return 0
    fi
  done
 return 1
}

load_msvc_env

repaths='cygpath winepath'
for repath in $repaths ''
do
  $repath --version >/dev/null 2>&1 &&
    break
done
test -n "$repath" ||
  error 176 "program not found: $repaths"

VS_PATH=$($repath -u "$VSINSTALLDIR")
VCXX_PATH=$($repath -u "$VCINSTALLDIR")
VCXX_BIN=$VCXX_PATH/bin
lib_exe=$VCXX_BIN/$PROG

test -x "$lib_exe" ||
  error 176 "$PROG not found in $VCXX_BIN"

outargs=/nologo
linkargs=
got_output_arg=false
source=
transform()
{
  # winepath -w $1
  echo "$1"
}

case $1 in
  (cru)
    shift
    outargs+=" /OUT:$(transform "$1")" ; shift
    ;;
  (x)  #gnah, we have to remove them one by one
    shift
    lib=$($repath -w $1)
    for f in $("$lib_exe" /LIST $lib |tail -n +4 |sed -e 's/\r//g'); do
      mkdir -p $(dirname "$f")
      "$lib_exe" $outargs "/EXTRACT:$f" "/OUT:$f" $lib
    done
    exit
    ;;
 (t)
    shift
    lib=$($repath -w $1)
    "$lib_exe" $outargs /LIST $lib |tail -n +4 |sed -e 's/\r//g'
    exit
    ;;
esac

while ! test -z $1; do
  larg=
  carg=
  case $1 in
    (-L*)   larg=/LIBPATH:$(transform "${1#-L}") ;;
    (-l*)   larg=${1#-l}.lib ;;
    (*.lib) larg=$1;;
    (*)     carg=$1;; # $(echo $1 | sed -e 's@/@\\@g');;
  esac
  outargs+=" $carg"
  linkargs+=" $larg"
  shift
done

verbose "command: \"$lib_exe\" $outargs $linkargs"
"$lib_exe" $outargs $linkargs
